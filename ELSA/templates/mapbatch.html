$def with (mail, type, id)
$var lang : $c.connectedUsers.users[mail].cuser.fields['language']
$var recursive : False
$var title : Map Recipe
$var location :
$code:
    elem = c.AllBatches.elements[id]
    krecipe = elem.get_group()
    summit = []
    usagesTop = []
    recipe = None
    if krecipe:
	if krecipe in c.AllGrRecipe.elements:
	    recipe = c.AllGrRecipe.elements[krecipe]
	    summit = [krecipe] + recipe.get_supermap_str()
	    usagesTop = c.AllGrUsage.get_usages_for_recipe(summit)
    events = elem.get_events(c)
    done = set()
<div class="container">
    <div class="row">
	<div class="col-xs-6">
	    <a href="/find/related/b_$id">$:(elem.statusIcon(c))$elem.fields['acronym'] <strong>$elem.getName(self.lang)</strong></a>
	</div>
	$if recipe:
		<div class="col-xs-5">
		    <a href="/find/related/gr_$krecipe">$:(recipe.statusIcon(c))$recipe.fields['acronym'] <strong>$recipe.getName(self.lang)</strong></a>
		</div>
    </div>
$ prev = ""
$ prevtime=elem.getTimestamp()
$ done = set()
<table style="padding:3px;border:1px solid #333;">
$for operation in events:
	$if operation.fields['h_id'] != prev:
		<tr style="padding:3px"><td style="text-align:right;background-color:#EEE;padding:3px">$(useful.timestamp_to_time(operation.getTimestamp()-prevtime) )mn</td>
		$ prev = operation.fields['h_id']
		$if prev and prev in c.AllCheckPoints.elements:
			$ checkpoint = c.AllCheckPoints.elements[prev]
			        <td style="padding:3px;border-top:1px solid #333;"><a href="/find/related/h_$checkpoint.getID()">$:(checkpoint.statusIcon(c))</a></td>
				<th style="padding:3px;border-top:1px solid #333;">
				$ acro = checkpoint.fields['acronym']
				$if prev in done:
				    <a href="#h_$acro">$acro</a> <span class="light">#$checkpoint.fields['rank']</span>
				$else:
				    <a name="h_$acro"></a>$acro <span class="light">#$checkpoint.fields['rank']</span> - <strong>$(checkpoint.getName(self.lang))</strong>
				    $ done.add(prev)
			</th><td style="padding:3px;border-top:1px solid #333;">$(checkpoint.fields['remark'])</td></tr>
		$else:
			<td style="padding:3px;border-top:1px solid #333;">&nbsp;</td>
			<td colspan="2" style="padding:3px;border-top:1px solid #333;">&nbsp;</td></th>
		$ prevtime = operation.getTimestamp()
	$ op_type = operation.get_type()
        <tr style="padding:3px">
		<th style="padding:3px">$(operation.fields['time'])</th>		
		<td style="padding:3px"><a href="/edit/$(op_type)_$(operation.getID())">$:operation.statusIcon(c)</a>
		</td><td>
                $ sourceModel = None
		$if (operation.fields[op_type+'m_id']):
			$ sourceModel = c.getObject(operation.fields[op_type+'m_id'], op_type+"m")
			$if sourceModel:
				<a href="/find/related/$(op_type)m_$(operation.fields[op_type+'m_id'])" style="color:#28A4C9">$(sourceModel.fields['acronym'])</a> - <strong>$(sourceModel.getName(self.lang))</strong>
		$if op_type == 't':
		    $ dest = operation.get_cont()
		    $:c.getHalfling('to')
		    <a href="/find/related/$dest.get_type()_$dest.getID()">$:(dest.statusIcon(c))$(dest.fields['acronym'])</a> $dest.getName(self.lang)
		$elif op_type == 'v':
			$ kbatch = ''
			$if operation.fields['dest']==id:
				$:c.getHalfling('from')
				$ kbatch = operation.fields['src']
			$else:
				$:c.getHalfling('to')
				$ kbatch = operation.fields['dest']
			$if kbatch and kbatch in c.AllBatches.elements:
				$ batch = c.AllBatches.elements[kbatch]
				<a href="/find/related/b_$kbatch">$:(batch.statusIcon(c))$(batch.fields['acronym'])</a> $batch.getName(self.lang)
			: <strong>$(operation.fields['quantity'])</strong>
			$ kmeasure = operation.fields['m_id']
			$if kmeasure and kmeasure in c.AllMeasures.elements:
				$ measure = c.AllMeasures.elements[kmeasure]
				$measure.fields['unit'] ($(measure.getName(self.lang)))
		$elif op_type == 'd':
			$ kmeasure = operation.fields['m_id']
			$ measure = None
			$if kmeasure and kmeasure in c.AllMeasures.elements:
			     $ measure = c.AllMeasures.elements[kmeasure]
                        $if not sourceModel and measure:
			     $(measure.getName(self.lang))
			: <strong>$(operation.fields['value'])</strong>
			$if measure:
			     $measure.fields['unit']
		</td>
		<td style="padding:3px">$(operation.fields['remark'])</td>
        </tr>
</table>
</div>